# Saga 패턴

Saga 패턴은 **마이크로서비스 아키텍처(MSA)**에서 **분산 트랜잭션을 관리**하기 위한 설계 패턴입니다.  
전통적인 2PC(2-Phase Commit)의 대안으로, **서비스 간의 트랜잭션을 이벤트나 메시지를 통해 연결**하여 전체적인 일관성을 유지합니다.

---

## 개념

> 하나의 큰 트랜잭션을 여러 개의 **작은 지역 트랜잭션(Local Transaction)**으로 나누고, 각 트랜잭션은 이벤트로 다음 트랜잭션을 트리거합니다.  
> 만약 중간에 실패하면, **앞서 실행된 트랜잭션들을 보상 트랜잭션(Compensating Transaction)**으로 되돌립니다.

---

## 구성 방식

1. **Choreography 기반**  
   - 서비스들이 직접 이벤트를 발행하고 구독  
   - 오케스트레이터 없음 (분산된 흐름)
2. **Orchestration 기반**  
   - 중앙 조정자가 각 서비스에게 작업을 지시 (오케스트레이터 존재)

---

## 예시 (항공권 예약)

1. 예약 서비스 → 예약 저장  
2. 예약 완료 이벤트 발행  
3. 결제 서비스 → 결제 처리  
4. 결제 완료 이벤트 발행  
5. 알림 서비스 → 알림 전송

> 만약 결제 실패 시 → 예약 서비스에 "예약 취소" 보상 트랜잭션 실행

---

## 장점

- 서비스 간 **결합도 낮음**
- **2PC보다 유연**하고 확장성이 높음
- **트랜잭션 실패 시 보상 방식으로 유연하게 복구 가능**

---

## 단점

- **보상 로직 구현이 필요**
- 트랜잭션 완료 시점이 **지연되거나 불확실**할 수 있음
- 중복 이벤트 처리, 순서 보장 등 **복잡한 문제 고려 필요**

---

## Saga vs 2PC

| 항목 | Saga 패턴 | 2PC (2-Phase Commit) |
|------|------------|----------------------|
| 방식 | 이벤트 기반 비동기 처리 | 분산 트랜잭션 동기 처리 |
| 일관성 | Eventually Consistent | Strong Consistency |
| 장애 허용 | 비교적 강함 | 약함 |
| 구현 난이도 | 보상 로직 필요 | 트랜잭션 매니저 필요 |
| 성능 | 높은 확장성 | 성능 저하 가능 |

---

## 관련 개념

- **보상 트랜잭션**: 실패한 작업을 되돌리기 위한 트랜잭션
- **이벤트 드리븐 아키텍처**: 이벤트를 통해 서비스 간 통신
- **Outbox 패턴**: 이벤트 발행의 신뢰성을 높이기 위한 설계

---

## 참고

- Saga 패턴은 Kafka, RabbitMQ 같은 **메시징 시스템**과 자주 함께 사용됨
- 대표적인 MSA 트랜잭션 관리 방식 중 하나
