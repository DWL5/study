# 보상 트랜잭션 (Compensating Transaction)

보상 트랜잭션은 분산 시스템에서 **트랜잭션의 롤백이 불가능하거나 어려운 경우**에 사용하는 전략입니다.  
특히 **마이크로서비스 아키텍처(MSA)**에서 자주 사용되며, **Saga 패턴**의 핵심 요소입니다.

---

## 정의

> “이미 완료된 작업을 취소하거나 되돌리는 동작을 명시적으로 정의해 실행하는 트랜잭션”

---

## 언제 필요한가?

- 각 서비스가 개별 DB를 갖고 있어 **분산 트랜잭션(2PC)**을 적용할 수 없을 때  
- 네트워크 장애로 일부 서비스만 성공하고 나머지는 실패했을 때  
- 서비스 간 트랜잭션을 **원자적으로 묶을 수 없을 때**

---

## 예시

### 항공권 예약 시스템:

1. **서비스1 (항공권 예약)** → 성공  
2. **서비스2 (결제 서비스)** → 실패  

→ 이 경우 **항공권 예약을 취소하는 보상 트랜잭션**을 실행해야 함

---

## Saga 패턴과의 관계

**Saga 패턴**은 보상 트랜잭션을 활용하여 트랜잭션 전체의 일관성을 유지하는 방식입니다.  
각 단계가 실패하면 **이전 단계들을 보상 트랜잭션으로 순차적으로 되돌립니다.**

### 예시 (예약 Saga)
```
[예약 시작] ─▶ 예약 요청 ─▶ 결제 요청 ─▶ 알림 발송
                   ▲             ▲
                   └─ 예약 취소 ◀─ 결제 취소
```

---

## 장점

- **분산 환경에 적합**  
- **비동기 처리에 유리**  
- 실패 시 **유연한 복구 시나리오** 설계 가능

---

## 단점

- 보상 로직을 **직접 명시적으로 정의**해야 함  
- **완전한 롤백을 보장하기 어려움**  
- **중복 처리, 순서 보장 등 고려 사항 많음**

---

## 요약

| 항목 | 설명 |
|------|------|
| 목적 | 분산 시스템에서 일관성 유지 |
| 방법 | 실패 시 보상 동작을 명시해 트랜잭션 효과 취소 |
| 활용 | Saga 패턴, MSA 기반 서비스 |
| 장점 | 트랜잭션 일관성, 복구 유연성 |
| 단점 | 구현 복잡성, 완전한 복구 어려움 |
